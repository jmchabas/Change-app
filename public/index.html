<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LifeOS</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0a0a0f;
      --card: #12121a;
      --border: #1e1e2e;
      --text: #e0e0e0;
      --muted: #6b7280;
      --green: #22c55e;
      --red: #ef4444;
      --amber: #f59e0b;
      --blue: #3b82f6;
      --purple: #a855f7;
      --green-dim: #22c55e22;
      --red-dim: #ef444422;
      --gray-dim: #6b728022;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'SF Mono', 'Fira Code', 'JetBrains Mono', monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 1.25rem;
      max-width: 960px;
      margin: 0 auto;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border);
    }
    header h1 { font-size: 1rem; font-weight: 700; letter-spacing: 0.12em; color: var(--blue); }
    header .meta { color: var(--muted); font-size: 0.75rem; text-align: right; }
    .section { margin-bottom: 1.25rem; }
    .section-title {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin-bottom: 0.6rem;
    }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem 1.1rem;
    }
    .card.alert { border-color: #ef444466; background: #ef444408; }
    .card.good { border-color: #22c55e44; }

    /* ── Today ── */
    .today-top { display: flex; align-items: flex-end; gap: 1rem; margin-bottom: 0.75rem; }
    .big-num { font-size: 3rem; font-weight: 700; line-height: 1; }
    .big-num .denom { font-size: 1.2rem; color: var(--muted); font-weight: 400; }
    .big-num.green { color: var(--green); }
    .big-num.amber { color: var(--amber); }
    .big-num.red { color: var(--red); }
    .mood-badge {
      font-size: 0.8rem;
      padding: 0.2rem 0.6rem;
      border-radius: 20px;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .mood-5, .mood-4 { background: #22c55e22; color: var(--green); }
    .mood-3 { background: #f59e0b22; color: var(--amber); }
    .mood-2, .mood-1 { background: #ef444422; color: var(--red); }

    .targets { margin-top: 0.75rem; font-size: 0.8rem; }
    .targets .t { padding: 0.2rem 0; color: var(--muted); }
    .targets .t span { color: var(--text); }

    /* ── Habit dots ── */
    .habits-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.35rem;
      margin-top: 0.5rem;
    }
    .habit-row { display: flex; align-items: center; gap: 0.45rem; font-size: 0.78rem; }
    .hdot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
    .hdot.on { background: var(--green); }
    .hdot.off { background: var(--red); opacity: 0.7; }
    .hdot.unk { background: #374151; }
    .habit-label { color: var(--muted); }
    .habit-label.done { color: var(--text); }

    /* ── Stress cluster ── */
    .cluster-warning {
      font-size: 0.8rem;
      color: var(--red);
      margin-top: 0.75rem;
      padding-top: 0.6rem;
      border-top: 1px solid #ef444433;
    }

    /* ── 7-day habit grid ── */
    .habit-grid-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
    .habit-grid-table th {
      color: var(--muted);
      font-weight: 400;
      padding: 0.3rem 0.4rem;
      text-align: center;
      font-size: 0.65rem;
      letter-spacing: 0.05em;
    }
    .habit-grid-table th.habit-name { text-align: left; letter-spacing: 0; }
    .habit-grid-table td { padding: 0.25rem 0.4rem; text-align: center; }
    .habit-grid-table td.habit-name { text-align: left; color: var(--muted); padding-left: 0; white-space: nowrap; }
    .cell {
      display: inline-block;
      width: 22px; height: 22px;
      border-radius: 4px;
      line-height: 22px;
      font-size: 0.7rem;
    }
    .cell.on  { background: #22c55e22; color: var(--green); }
    .cell.off { background: #ef444422; color: var(--red); }
    .cell.unk { background: var(--gray-dim); color: #374151; }

    /* ── Trend chart ── */
    .chart-wrap { height: 180px; }
    .chart-wrap canvas { width: 100% !important; }

    /* ── Top misses ── */
    .miss-row { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 0.5rem; font-size: 0.8rem; }
    .miss-bar-bg { flex: 1; height: 6px; background: #1e1e2e; border-radius: 3px; overflow: hidden; }
    .miss-bar { height: 100%; border-radius: 3px; background: var(--red); }
    .miss-bar.ok { background: var(--green); }
    .miss-label { color: var(--muted); width: 80px; flex-shrink: 0; }
    .miss-count { color: var(--text); width: 28px; text-align: right; flex-shrink: 0; }

    /* ── Coaching ── */
    .coaching-text {
      font-size: 0.82rem;
      line-height: 1.7;
      color: var(--text);
      white-space: pre-wrap;
    }
    .coaching-meta { font-size: 0.7rem; color: var(--muted); margin-bottom: 0.5rem; }

    /* ── Break log ── */
    .break-item { font-size: 0.78rem; padding: 0.35rem 0; border-bottom: 1px solid var(--border); display: flex; gap: 0.6rem; }
    .break-item:last-child { border-bottom: none; }
    .break-date { color: var(--muted); flex-shrink: 0; width: 44px; }
    .break-habit { color: var(--amber); flex-shrink: 0; width: 80px; }
    .break-reason { color: var(--text); }

    /* ── Misc ── */
    .muted { color: var(--muted); }
    .empty { font-size: 0.8rem; color: var(--muted); padding: 0.5rem 0; }

    @media (max-width: 600px) {
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
      .big-num { font-size: 2.5rem; }
      .habit-grid-table { font-size: 0.7rem; }
      .cell { width: 18px; height: 18px; line-height: 18px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>LIFEOS</h1>
    <div class="meta">
      <div id="header-date"></div>
      <div id="refresh-hint" style="margin-top:2px"></div>
    </div>
  </header>
  <div id="app"><div class="empty" style="text-align:center;padding:3rem">Loading...</div></div>

  <script>
    const HABITS = [
      { key: 'no_escape_media', label: 'Focus' },
      { key: 'fixed_eating',    label: 'Eating' },
      { key: 'clean_evening',   label: 'Clean' },
      { key: 'work_win',        label: 'Work win' },
      { key: 'personal_win',    label: 'Perso win' },
      { key: 'gym',             label: 'Gym' },
      { key: 'kids_quality',    label: 'Kids' },
      { key: 'bed_on_time',     label: 'Bed 10pm' },
    ];

    const scoreColor = s => s >= 7 ? 'green' : s >= 5 ? 'amber' : 'red';
    const moodLabel = m => ['', 'Terrible', 'Rough', 'Okay', 'Good', 'Great'][m] || '—';
    const yn = v => v === 1 ? '<span style="color:var(--green)">✓</span>'
                  : v === 0 ? '<span style="color:var(--red)">✗</span>'
                  : '<span style="color:#374151">·</span>';

    function cellHtml(val) {
      if (val === 1) return `<span class="cell on">✓</span>`;
      if (val === 0) return `<span class="cell off">✗</span>`;
      return `<span class="cell unk">·</span>`;
    }

    function todayCard(log, targets) {
      const score = log ? log.total_score ?? 0 : null;
      const mood = log ? log.mood : null;
      const isAlert = log && ['no_escape_media','fixed_eating','clean_evening'].filter(h => log[h] === 0).length >= 2;

      const habitsHtml = HABITS.map(h => {
        const v = log ? log[h.key] : null;
        const cls = v === 1 ? 'on' : v === 0 ? 'off' : 'unk';
        const labelCls = v === 1 ? 'done' : '';
        return `<div class="habit-row">
          <div class="hdot ${cls}"></div>
          <span class="habit-label ${labelCls}">${h.label}</span>
        </div>`;
      }).join('');

      const targetsHtml = targets
        ? `<div class="targets">
            <div class="t">→ Work: <span>${targets.work_target || '—'}</span></div>
            <div class="t">→ Personal: <span>${targets.personal_target || '—'}</span></div>
           </div>`
        : `<div class="targets"><div class="t muted">No targets set — use /targets</div></div>`;

      const clusterHtml = isAlert
        ? `<div class="cluster-warning">⚠ Stress cluster — 2+ escapes today</div>` : '';

      return `<div class="card ${isAlert ? 'alert' : score >= 6 ? 'good' : ''}">
        <div class="section-title">Today</div>
        <div class="today-top">
          ${score !== null
            ? `<div class="big-num ${scoreColor(score)}">${score}<span class="denom">/8</span></div>`
            : `<div class="big-num" style="color:var(--muted)">—<span class="denom">/8</span></div>`}
          ${mood ? `<div><div class="mood-badge mood-${mood}">Mood ${mood}/5 · ${moodLabel(mood)}</div></div>` : ''}
        </div>
        ${targetsHtml}
        <div class="habits-grid">${habitsHtml}</div>
        ${clusterHtml}
        ${log && log.stress_note ? `<div style="margin-top:.6rem;font-size:.75rem;color:var(--muted)">Note: ${log.stress_note}</div>` : ''}
      </div>`;
    }

    function habitGridCard(logs) {
      const days = [...logs].reverse();
      const headers = days.map(l => `<th>${l.date.slice(5)}</th>`).join('');

      const rows = HABITS.map(h => {
        const cells = days.map(l => `<td>${cellHtml(l[h.key])}</td>`).join('');
        return `<tr><td class="habit-name">${h.label}</td>${cells}</tr>`;
      }).join('');

      return `<div class="card">
        <div class="section-title">7-Day Habit Grid</div>
        <div style="overflow-x:auto">
          <table class="habit-grid-table">
            <tr><th class="habit-name"></th>${headers}</tr>
            ${rows}
          </table>
        </div>
      </div>`;
    }

    function missesCard(logs) {
      const counts = HABITS.map(h => {
        const logged = logs.filter(l => l[h.key] !== null);
        const done = logs.filter(l => l[h.key] === 1).length;
        const total = logged.length;
        return { label: h.label, done, total, missed: total - done };
      }).sort((a, b) => b.missed - a.missed);

      const rows = counts.map(c => {
        const pct = c.total > 0 ? (c.done / c.total * 100) : 0;
        const cls = c.missed === 0 ? 'ok' : '';
        return `<div class="miss-row">
          <span class="miss-label">${c.label}</span>
          <div class="miss-bar-bg"><div class="miss-bar ${cls}" style="width:${pct}%"></div></div>
          <span class="miss-count" style="color:${c.missed === 0 ? 'var(--green)' : c.missed >= 3 ? 'var(--red)' : 'var(--amber)'}">
            ${c.done}/${c.total}
          </span>
        </div>`;
      }).join('');

      return `<div class="card">
        <div class="section-title">Habit Success — Last 7 Days</div>
        ${counts[0].total === 0 ? '<p class="empty">No data yet.</p>' : rows}
      </div>`;
    }

    function coachingCard(reviews) {
      if (!reviews.length) return `<div class="card">
        <div class="section-title">Latest Coaching</div>
        <p class="empty">First Sunday review coming up.</p>
      </div>`;
      const r = reviews[0];
      return `<div class="card">
        <div class="section-title">Latest Coaching</div>
        <div class="coaching-meta">Week of ${r.week_start} · Avg ${r.avg_score}/8${r.avg_mood ? ` · Mood ${r.avg_mood}/5` : ''}</div>
        <div class="coaching-text">${r.coaching_text || '—'}</div>
      </div>`;
    }

    function breakLogCard(breaks) {
      if (!breaks.length) return `<div class="card">
        <div class="section-title">Stress Log</div>
        <p class="empty">No breaks logged yet.</p>
      </div>`;
      const items = breaks.slice(0, 12).map(b => `
        <div class="break-item">
          <span class="break-date">${b.date.slice(5)}</span>
          <span class="break-habit">${b.habit.replace('_', ' ')}</span>
          <span class="break-reason">${b.reason}</span>
        </div>`).join('');
      return `<div class="card">
        <div class="section-title">Stress Log</div>
        ${items}
      </div>`;
    }

    let scoreChart = null;

    function renderTrendChart(logs) {
      const ctx = document.getElementById('trend-chart');
      if (!ctx || logs.length === 0) return;
      const days = [...logs].reverse();
      const labels = days.map(l => l.date.slice(5));
      const scores = days.map(l => l.total_score ?? null);
      const moods = days.map(l => l.mood ? (l.mood / 5 * 8) : null); // normalize mood to /8 scale

      if (scoreChart) scoreChart.destroy();
      scoreChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Score /8',
              data: scores,
              borderColor: '#3b82f6',
              backgroundColor: '#3b82f615',
              fill: true,
              tension: 0.35,
              pointBackgroundColor: scores.map(s =>
                s === null ? 'transparent' : s >= 6 ? '#22c55e' : s >= 4 ? '#f59e0b' : '#ef4444'),
              pointRadius: 5,
              pointHoverRadius: 7,
              spanGaps: true,
            },
            {
              label: 'Mood (scaled)',
              data: moods,
              borderColor: '#a855f7',
              borderDash: [4, 4],
              backgroundColor: 'transparent',
              tension: 0.35,
              pointBackgroundColor: '#a855f7',
              pointRadius: 3,
              spanGaps: true,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              labels: { color: '#6b7280', font: { size: 10 }, boxWidth: 12 },
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  if (ctx.datasetIndex === 1) {
                    const raw = ctx.raw;
                    return raw !== null ? `Mood: ${Math.round(raw / 8 * 5)}/5` : '';
                  }
                  return `Score: ${ctx.raw}/8`;
                },
              },
            },
          },
          scales: {
            y: {
              min: 0, max: 8,
              ticks: { stepSize: 2, color: '#6b7280', font: { size: 10 } },
              grid: { color: '#1e1e2e' },
            },
            x: {
              ticks: { color: '#6b7280', font: { size: 10 } },
              grid: { display: false },
            },
          },
        },
      });
    }

    async function load() {
      try {
        const [todayRes, weekRes, histRes, reviewsRes, breaksRes] = await Promise.all([
          fetch('/api/today').then(r => r.json()),
          fetch('/api/week').then(r => r.json()),
          fetch('/api/history').then(r => r.json()),
          fetch('/api/reviews').then(r => r.json()),
          fetch('/api/breaks').then(r => r.json()),
        ]);

        const { log, targets, date } = todayRes;
        const { logs, trend, avg, avgMood } = weekRes;
        const { reviews } = reviewsRes;
        const { breaks } = breaksRes;
        const allLogs = histRes.logs;

        document.getElementById('header-date').textContent = date;
        document.getElementById('refresh-hint').textContent =
          `avg ${avg ?? '—'}/8${avgMood ? ` · mood ${avgMood}/5` : ''}${trend ? ` · ${trend}` : ''}`;

        document.getElementById('app').innerHTML = `
          <div class="section">
            <div class="grid-2">
              ${todayCard(log, targets)}
              ${habitGridCard(logs.length > 0 ? logs : [])}
            </div>
          </div>

          <div class="section">
            <div class="card chart-wrap" style="height:200px">
              <div class="section-title">Score + Mood Trend</div>
              <div style="height:160px"><canvas id="trend-chart"></canvas></div>
            </div>
          </div>

          <div class="section">
            <div class="grid-2">
              ${missesCard(logs)}
              ${coachingCard(reviews)}
            </div>
          </div>

          <div class="section">
            ${breakLogCard(breaks)}
          </div>
        `;

        renderTrendChart(allLogs.slice(0, 30).reverse());

      } catch (err) {
        document.getElementById('app').innerHTML =
          `<div class="empty" style="text-align:center;padding:3rem">Failed to load — is the server running?<br><small>${err.message}</small></div>`;
      }
    }

    document.getElementById('header-date').textContent = new Date().toISOString().slice(0, 10);
    load();
    setInterval(load, 5 * 60 * 1000); // refresh every 5 min
  </script>
</body>
</html>
